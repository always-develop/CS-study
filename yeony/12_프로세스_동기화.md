# 12-1. 동기화란

- 동시다발적으로 실행되는 프로세스들의 실행 순서와 자원의 일관성을 보장하기 위해서 운영체제는 동기화가 잘 되어야 한다

## 동기화의 의미

- 독립적인 프로세스더라도 서로 협력해야하는 경우가 있다
  - 입력하고, 입력한 것의 맞춤법 검사를 하며 화면에 나타내는 것.. !
- 프로세스 동기화란?
  - 프로세스 사이의 수행 시기를 맞추는 것
    - 실행 순서 제어 : 순서대로 실행을 대기한다
    - 상호 배제 : 동시에 접근하면 안되는 자원에 하나의 프로세스만 접근하게 한다

**실행 순서 제어와 동기화**

- writer과 reader가 동시에 실행 중이다
- writer은 Book.txt 파일에 값을 저장하는 프로세스, reader은 Book.txt 파일을 읽어들이는 프로세스
- writer가 끝나야 reader을 실행할 수 있다
  - 저장하기도 전에 읽어들이는 것은 말도 안되니까..!
- 동시에 실행되더라도 먼저 선행되어야 하는 프로세스가 있다

  **상호 배제를 위한 동기화**

- 공유 불가능한 자원을 동시 사용을 피하기 위해 사용하는 알고리즘이다
- A 프로세스는 현재 저축된 금액에 2만원을 넣는 프로세스, B 프로세스는 현재 저축된 금액에 5만원을 넣는 프로세스이다
  > 프로세스 과정
  1. 계좌의 잔액(10만원)을 읽어 들인다.
  2. 읽어 들인 잔액에서 {금액}만큼 더한다.
  3. 더한 값을 저장한다.
     >
- 만약 A와 B가 동시에 일어난다면..
- 계좌의 잔액을 동시에 확인하게 되면 A와 B가 기억하는 잔액은 10만원일 것이고, 예상하는 금액인 17만원이 아닌 12만원이나 15만원이 결과로 나올 수 있다
- `잔액` 이라는 데이터를 공유하는데 A나 B의 프로세스 중 하나의 프로세스가 완전 끝이 난 다음 다음 프로세스가 `잔액` 에 접근해야 올바른 결과를 예상할 수 있다

## 생산자와 소비자 문제

- 생산자는 물건을 계속 생산하는 프로세스이고, 소비자는 물건을 계속 소비하는 프로세스이다]
- 이들은 `총합` 이라는 데이터를 공유한다
- 총합이 10이라 가정하고, 생산자와 소비자을 동시에 100,000번 실행한다면?
  - 계속 10에 머물러 있을 것이라 기대할 수 있다..
- 하지만 동기화가 이루어지지 않으면 위의 `잔액` 의 예제와 같이 `총합` 이라는 데이터를 동시 접근하여 기대하지 못한 결과를 볼 수 있다

## 공유 자원과 임계 구역

- 위의 예제들 처럼 총합과 잔액은 `공유 자원`이다
- 공유 자원은 전역 변수도, 파일도, 입출력장치, 보조기억장치가 될 수 있다
- 동시에 실행했을 때 문제가 발생하는 자원에 접근하는 코드 영역을 `임계 구역`이라 한다
- 2개 이상의 프로세스가 임계 구역에 진입하려고 할 때, 둘 중하나는 대기 상태가 되어야 한다
  - 하지만 이렇게 되지 못해서 2개 이상의 프로세스가 동시에 임계 구역에 진입하기 되면 문제가 발생한다 → `레이스 컨디션`
- 레이스 컨디션이 발생하는 근본적인 이유는 저급언어로 동작하는 컴퓨터가 한 줄의 고급 언어를 실행하는 과정에서 `문맥 교환` 이 일어나 발생한다
- 상호 재베를 위한 동기화를 위해 아래 세 가지 원칙은 지켜져야 한다
  - 상호 배제, mutual exclusion
  - 진행, progress
  - 유한 대기, bounded waiting
    - 한 프로세스가 임계 구역에 진입하고 싶으면, 언젠가는 임계 구역에 들어가야 한다

# 12-2. 동기화 기법

- 동기화를 위한 대표적인 도구 3가지
  - 뮤텍스 락
  - 세마포
  - 모니터

## 뮤텍스 락, Mutex lock, MUTual Exclusion lock

- 임계 구역에 프로세스가 이미 있음을 알리기 위해 잠금을 해놓은 상태
- 잠겨 있으면 프로세스 진입이 불가하고, 잠겨 있지 않으면 프로세스가 진입이 가능한 상태이다
- 형태
  - 자물쇠 : 프로세스들이 공유하는 전역 변수, lock
  - 잠금 역할 : `acquire` 함수
  - 잠금 해제 역할 : `release` 함수
- `acquire` 함수
  - 프로세스가 임계 구역이 진입하기 전에 호출하는 함수
  - 임계 구역이 열릴 때까지 반복적으로 확인하고, 열려 있으면 잠그는 역할을 한다
- `release` 함수
  - 임계 구역에서 작업이 끝나고 호출하는 함수
- `acquire` 함수는 계속 임계 구역의 잠금 상태를 계속 확인한다
  - 이런 대기 방식을 `바쁜 대기(busy wait)` 라고 한다

## 세마포, semaphore

- 뮤텍스 락과 비슷하지만 일반화된 도구
- 뮤텍스 락은 임계 구역이 하나만 있을 경우를 가정하여 만들어진 도구이고, 세마포는 여러 개의 임계 구역을 예상하고 만들었다
- 형태
  - 임계 구역에 진입이 가능한 프로세스의 개수, 전역 변수 S
  - 임계 구역에 들어가도 되는지, 기다려야 하는지 알려주는 `wait` 함수
  - 기다리는 프로세스에게 가도 된다는 신호를 주는 `signal` 함수
- 뮤텍스 락과 동일하게 프로세스가 임계 구역에 진입하기 전, 후로 `wait` , `signal` 이 호출된다
- 뮤텍스 락과 동일하게 `wait` 함수는 임계 구역에 진입할 수 있는 프로세스의 개수를 계속적으로 확인한다
  - 바쁜 대기를 하는 것!
- 하지만 차이가 있다면 세마포는 사용할 수 있는 자원이 없으면 프로세스를 대기 상태로 만들고, 세마포의 대기 큐에 집어 넣는다. 그리고 사용할 수 있는 자원이 생기면 (signal 함수가 호출) 대기 큐에서 꺼내서 준비 큐로 넣는다
- 프로세스의 순서를 제어하기 위해서는 실행할 프로세스 뒤에 `signal` 함수, 다음 차례의 프로세스에 `wait` 함수를 붙이면 된다

## 모니터, monitor

- 임계 구역 앞뒤로 함수를 매번 붙이는 것은 번거로운 일이 된다
- 또한 실수로 함수를 잘못 배치시키면 충분히 버그가 생길 수 있다
- 이런 것들을 보완한 동기화 도구는 `모니터`이다
- 공유 자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 묶어서 관리한다
  - 프로세스는 인터페이스를 통해서만 공유 자원에 접근할 수 있다
  - 공유 자원이 필요한 프로세스를 큐에 삽입하고, 큐는 모니터의 인터페이스를 통해 공유 자원으로 접근한다
  - 모니터에는 하나의 프로세스만 진입할 수 있기 때문에 상호 배제를 위한 동기화를 제공한다
- 모니터에서 실행 순서를 위한 동기화는 조건 변수를 사용한다
  - 조건 변수로 `wait` 와 `signal` 연산을 수행할 수 있다
  - 모니터에 프로세스가 실행되고 있는데, 우선순위에 의해 다른 프로세스가 실행되어야 한다면 현재 실행되는 프로세스의 조건변수가 `wait` 함수를 호출하고 조건 변수 큐로 이동한다
  - 모니터가 비게 되어 우선순위가 높은 프로세스가 실행되고, 실행이 끝나면 조건 변수 큐에 있던 프로세스에게 `signal` 함수를 호출하여 다시 재 실행되게 한다
